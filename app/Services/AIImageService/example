<?php

declare(strict_types=1);

use App\Services\AIImageService\AIImageService;
use App\Services\AIImageService\AIImageServiceFactory;
use App\Services\AIImageService\Providers\OpenAI\OpenAIProvider;
use App\Services\AIImageService\DTOs\ProviderConfig;
use App\Services\AIImageService\DTOs\GenerateImageRequest;
use App\Services\AIImageService\DTOs\EditImageRequest;

// ============================================
// مثال 1: تنظیمات اولیه و ثبت Provider
// ============================================

// ایجاد سرویس اصلی
$imageService = new AIImageService();

// تنظیمات OpenAI Provider
$openAIConfig = new ProviderConfig(
    name: 'openai',
    apiKey: 'YOUR_OPENAI_API_KEY',
    baseUrl: 'https://api.openai.com',
    options: [
        'model' => 'dall-e-3',
        'quality' => 'standard', // or 'hd'
    ],
    timeout: 120,
    enabled: true
);

// ثبت Provider
$openAIProvider = new OpenAIProvider($openAIConfig);
$imageService->registerProvider($openAIProvider);

// ============================================
// مثال 2: تولید تصویر ساده
// ============================================

$generateRequest = new GenerateImageRequest(
    prompt: 'A beautiful sunset over mountains',
    numberOfImages: 1,
    size: '1024x1024',
    style: 'vivid'
);

$response = $imageService->generate($generateRequest);

if ($response->success) {
    echo "✅ Image generated successfully!\n";
    echo "Provider: {$response->provider}\n";
    echo "Processing time: {$response->processingTime}s\n";

    foreach ($response->images as $image) {
        echo "Image URL: {$image['url']}\n";
    }
} else {
    echo "❌ Error: {$response->error}\n";
}

// ============================================
// مثال 3: تولید تصویر با تنظیمات پیشرفته
// ============================================

$advancedRequest = new GenerateImageRequest(
    prompt: 'A futuristic city with flying cars',
    negativePrompt: 'blurry, low quality',
    numberOfImages: 2,
    size: '1024x1024',
    style: 'vivid',
    colors: ['blue', 'purple', 'silver'],
    metadata: [
        'user_id' => 123,
        'project_id' => 456,
    ]
);

$response = $imageService->generate($advancedRequest);
echo "\n" . json_encode($response->toArray(), JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n";

// ============================================
// مثال 4: ویرایش تصویر (Inpaint)
// ============================================

$editRequest = new EditImageRequest(
    imageUrl: 'https://example.com/original-image.png',
    operation: 'inpaint',
    prompt: 'Add a red car in the empty space',
    maskUrl: 'https://example.com/mask.png',
    parameters: [
        'size' => '1024x1024',
    ]
);

$response = $imageService->edit($editRequest);

if ($response->success) {
    echo "\n✅ Image edited successfully!\n";
    foreach ($response->images as $image) {
        echo "Edited image URL: {$image['url']}\n";
    }
}

// ============================================
// مثال 5: ایجاد Variation از تصویر
// ============================================

$variationRequest = new EditImageRequest(
    imageUrl: 'https://example.com/base-image.png',
    operation: 'variation',
    parameters: [
        'n' => 3,
        'size' => '1024x1024',
    ]
);

$response = $imageService->edit($variationRequest);
echo "\n" . json_encode($response->toArray(), JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n";

// ============================================
// مثال 6: استفاده با Provider مشخص
// ============================================

// اگر چند Provider داشته باشید، می‌توانید یکی را انتخاب کنید
$response = $imageService->generate($generateRequest, 'openai');

// ============================================
// مثال 7: بررسی Provider های در دسترس
// ============================================

$availableProviders = $imageService->getAvailableProviders();
echo "\nAvailable Providers:\n";
foreach ($availableProviders as $provider) {
    echo "- {$provider->getName()}\n";
}

// ============================================
// مثال 8: استفاده از Gemini 2.5 Flash
// ============================================

$geminiService = AIImageServiceFactory::createWithGemini('YOUR_GEMINI_API_KEY');

$geminiRequest = new GenerateImageRequest(
    prompt: 'A serene Japanese garden with cherry blossoms',
    style: 'natural',
    colors: ['pink', 'green', 'white'],
    size: '1024x1024'
);

$response = $geminiService->generate($geminiRequest);
echo "\n=== Gemini Response ===\n";
echo json_encode($response->toArray(), JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n";

// ویرایش با Gemini (enhance)
$geminiEditRequest = new EditImageRequest(
    imageUrl: 'https://example.com/image.jpg',
    operation: 'enhance',
    prompt: 'Enhance the image quality and add more vibrant colors'
);

$response = $geminiService->edit($geminiEditRequest);
echo "\n=== Gemini Edit Response ===\n";
echo json_encode($response->toArray(), JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n";

// ============================================
// مثال 9: استفاده از Seedream 4
// ============================================

$seedreamService = AIImageServiceFactory::createWithSeedream('YOUR_SEEDREAM_API_KEY');

$seedreamRequest = new GenerateImageRequest(
    prompt: 'A cyberpunk city at night with neon lights',
    negativePrompt: 'blurry, low quality, distorted',
    numberOfImages: 2,
    size: '1024x1024',
    style: 'cinematic',
    colors: ['cyan', 'magenta', 'purple']
);

$response = $seedreamService->generate($seedreamRequest);
echo "\n=== Seedream Response ===\n";
echo json_encode($response->toArray(), JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n";

// Upscale با Seedream
$upscaleRequest = new EditImageRequest(
    imageUrl: 'https://example.com/low-res-image.jpg',
    operation: 'upscale',
    parameters: [
        'scale_factor' => 4,
        'enhance_details' => true,
    ]
);

$response = $seedreamService->edit($upscaleRequest);
echo "\n=== Seedream Upscale Response ===\n";
echo json_encode($response->toArray(), JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n";

// Outpaint با Seedream
$outpaintRequest = new EditImageRequest(
    imageUrl: 'https://example.com/image.jpg',
    operation: 'outpaint',
    prompt: 'Extend the landscape naturally',
    parameters: [
        'direction' => 'all',
        'expansion_ratio' => 1.5,
    ]
);

$response = $seedreamService->edit($outpaintRequest);
echo "\n=== Seedream Outpaint Response ===\n";
echo json_encode($response->toArray(), JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n";

// ============================================
// مثال 10: استفاده از چند Provider با Factory
// ============================================

$multiProviderService = AIImageServiceFactory::createWithMultipleProviders([
    [
        'type' => 'openai',
        'api_key' => 'YOUR_OPENAI_KEY',
        'enabled' => true,
        'priority' => 1,
    ],
    [
        'type' => 'gemini',
        'api_key' => 'YOUR_GEMINI_KEY',
        'enabled' => true,
        'priority' => 2,
    ],
    [
        'type' => 'seedream',
        'api_key' => 'YOUR_SEEDREAM_KEY',
        'enabled' => true,
        'priority' => 3,
    ],
    [
        'type' => 'stability-ai',
        'api_key' => 'YOUR_STABILITY_KEY',
        'enabled' => true,
        'priority' => 4,
    ],
]);

// سرویس به صورت خودکار از اولین Provider موجود استفاده می‌کند
$response = $multiProviderService->generate($generateRequest);
echo "\n=== Multi-Provider Response ===\n";
echo "Used Provider: {$response->provider}\n";

// یا می‌توانید Provider خاصی را انتخاب کنید
$response = $multiProviderService->generate($generateRequest, 'seedream');
echo "Forced Provider: {$response->provider}\n";

// ============================================
// مثال 11: استفاده از Environment Variables
// ============================================

// فرض کنید فایل .env شما تنظیم شده است
$envService = AIImageServiceFactory::createFromEnv();

$response = $envService->generate($generateRequest);
echo "\n=== Environment-based Service ===\n";
echo "Provider: {$response->provider}\n";

$availableProviders = $envService->getAvailableProviders();
echo "Available Providers from ENV: " . count($availableProviders) . "\n";
foreach ($availableProviders as $provider) {
    echo "  - {$provider->getName()}\n";
}
